{% extends "base.html" %}

{% block title %}Finance Forecast - Dashboard{% endblock %}

{% block content %}
<div class="w-full px-6 py-8">
  <div class="w-full space-y-6">
    
    <!-- Dashboard Header -->
    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
      <div>
        <h1 class="text-3xl font-bold text-base-content">Financial Dashboard</h1>
        <p class="text-base-content/70">Track your account performance and financial goals</p>
      </div>
      
      <!-- Action Buttons -->
      <div class="flex flex-wrap gap-3">
        <button class="btn btn-primary">
          <i class="bi bi-arrow-up-right"></i>
          Trade
        </button>
        <button class="btn btn-success" onclick="openTransactionModal('deposit')">
          <i class="bi bi-plus-circle"></i>
          Deposit
        </button>
        <button class="btn btn-warning" onclick="openTransactionModal('withdraw')">
          <i class="bi bi-dash-circle"></i>
          Withdrawal
        </button>
      </div>
    </div>

    <!-- Main Dashboard Grid -->
    <div class="grid lg:grid-cols-4 gap-6">
      
      <!-- Financial Comparison Chart - Main Card -->
      <div class="lg:col-span-3">
        <div class="card bg-base-100 shadow-xl">
          <div class="card-body">
            <div class="flex items-center justify-between mb-6">
              <div>
                <h2 class="card-title text-xl">
                  <i class="bi bi-bar-chart"></i>
                  Financial Comparison Chart
                </h2>
                <p class="text-base-content/70">Compare your account performance with different scenarios over time</p>
              </div>
              <div class="dropdown dropdown-end">
                <div tabindex="0" role="button" class="btn btn-ghost btn-sm">
                  <i class="bi bi-three-dots"></i>
                </div>
                <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box z-[1] w-52 p-2 shadow">
                  <li><a><i class="bi bi-download"></i> Export Data</a></li>
                  <li><a><i class="bi bi-gear"></i> Settings</a></li>
                </ul>
              </div>
            </div>
            
            <!-- Chart Container -->
            <div class="bg-base-100 rounded-lg p-6 min-h-[400px] relative">
              <canvas id="financialChart" class="w-full h-[400px]"></canvas>
              <div id="chartLoadingMsg" class="absolute inset-0 flex items-center justify-center text-base-content/60">
                <div class="loading loading-spinner loading-lg"></div>
                <span class="ml-4">Loading chart data...</span>
              </div>
              <div id="chartEmptyMsg" class="absolute inset-0 flex items-center justify-center text-base-content/60 hidden">
                <div class="text-center">
                  <i class="bi bi-bar-chart text-4xl mb-4"></i>
                  <p class="text-lg">No transaction data yet</p>
                  <p class="text-sm">Add your first deposit to see your financial growth</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Sidebar - Key Metrics -->
      <div class="space-y-6">
        
        <!-- Current Balance Card -->
        <div class="card bg-base-100 shadow-xl">
          <div class="card-body">
            <h3 class="text-sm font-medium text-base-content/70">Current Balance</h3>
            <div class="flex items-baseline space-x-1">
              <span class="text-sm text-base-content/70">$</span>
              <span id="currentBalance" class="text-3xl font-bold text-base-content">0.00</span>
            </div>
            <div class="flex items-center space-x-1 text-sm">
              <i class="bi bi-wallet2 text-info"></i>
              <span id="transactionCount" class="text-base-content/70">0 transactions</span>
            </div>
          </div>
        </div>

        <!-- Monthly Growth Card -->
        <div class="card bg-base-100 shadow-xl">
          <div class="card-body">
            <div class="flex items-center justify-between">
              <h3 class="text-sm font-medium text-base-content/70">Monthly Growth</h3>
              <i class="bi bi-trending-up text-success"></i>
            </div>
            <div class="text-3xl font-bold text-base-content">4.1%</div>
            <div class="text-sm text-base-content/70">Average growth rate</div>
          </div>
        </div>

        <!-- Active Scenarios Card -->
        <div class="card bg-base-100 shadow-xl">
          <div class="card-body">
            <div class="flex items-center justify-between">
              <h3 class="text-sm font-medium text-base-content/70">Active Scenarios</h3>
              <div class="dropdown dropdown-end">
                <div tabindex="0" role="button" class="btn btn-ghost btn-xs">
                  <i class="bi bi-gear"></i>
                </div>
                <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box z-[1] w-44 p-2 shadow">
                  <li><a><i class="bi bi-plus"></i> Add Scenario</a></li>
                  <li><a><i class="bi bi-pencil"></i> Edit</a></li>
                </ul>
              </div>
            </div>
            <div class="text-3xl font-bold text-base-content">3</div>
            <div class="text-sm text-base-content/70">Scenarios being compared</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bottom Statistics Cards -->
    <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6">
      
      <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-base-content/70">Total Invested</p>
              <p class="text-2xl font-bold">$18,450</p>
            </div>
            <div class="avatar placeholder">
              <div class="bg-primary text-primary-content rounded-full w-10 h-10">
                <i class="bi bi-wallet2"></i>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-base-content/70">Total Returns</p>
              <p class="text-2xl font-bold text-success">$4,068</p>
            </div>
            <div class="avatar placeholder">
              <div class="bg-success text-success-content rounded-full w-10 h-10">
                <i class="bi bi-arrow-up-circle"></i>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-base-content/70">Portfolio Performance</p>
              <p class="text-2xl font-bold">+22.1%</p>
            </div>
            <div class="avatar placeholder">
              <div class="bg-info text-info-content rounded-full w-10 h-10">
                <i class="bi bi-graph-up"></i>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-base-content/70">Risk Score</p>
              <p class="text-2xl font-bold text-warning">Moderate</p>
            </div>
            <div class="avatar placeholder">
              <div class="bg-warning text-warning-content rounded-full w-10 h-10">
                <i class="bi bi-shield-check"></i>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>

  </div>
</div>

<!-- Transaction Modal -->
<dialog id="transactionModal" class="modal">
  <div class="modal-box w-11/12 max-w-md">
    <form method="dialog">
      <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
    </form>
    
    <h3 class="font-bold text-lg mb-6">Add Transaction</h3>
    
    <form id="transactionForm" class="space-y-4">
      <!-- Direction Tabs -->
      <div class="form-control">
        <label class="label">
          <span class="label-text">Direction</span>
        </label>
        <div class="tabs tabs-boxed">
          <input type="radio" name="direction" id="depositTab" value="deposit" class="tab-radio" hidden>
          <label for="depositTab" class="tab tab-active" id="depositLabel">
            <i class="bi bi-plus-circle mr-2"></i>Deposit
          </label>
          
          <input type="radio" name="direction" id="withdrawTab" value="withdraw" class="tab-radio" hidden>
          <label for="withdrawTab" class="tab" id="withdrawLabel">
            <i class="bi bi-dash-circle mr-2"></i>Withdraw
          </label>
        </div>
      </div>

      <!-- Amount Input -->
      <div class="form-control">
        <label class="label">
          <span class="label-text">Amount</span>
        </label>
        <label class="input input-bordered flex items-center gap-2">
          <span class="text-base-content/70">$</span>
          <input type="text" id="amountInput" name="amount" placeholder="0.00" class="grow" required>
        </label>
      </div>

      <!-- Description -->
      <div class="form-control">
        <label class="label">
          <span class="label-text">Description</span>
        </label>
        <textarea name="description" class="textarea textarea-bordered" placeholder="Enter transaction description (optional)" rows="3"></textarea>
      </div>

      <!-- Date -->
      <div class="form-control">
        <label class="label">
          <span class="label-text">Date</span>
        </label>
        <input type="date" name="date" id="dateInput" class="input input-bordered" required>
      </div>

      <!-- Submit Button -->
      <div class="modal-action">
        <button type="button" class="btn btn-ghost" onclick="document.getElementById('transactionModal').close()">Cancel</button>
        <button type="submit" class="btn btn-primary" id="submitBtn">Add Deposit</button>
      </div>
    </form>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>close</button>
  </form>
</dialog>

{% endblock %}

{% block footer %}
<div class="container mx-auto px-4 py-8">
  <div class="max-w-4xl mx-auto">
    <!-- Footer -->
    <div class="text-center">
      <p class="text-base-content/60">
        Built with ❤️ using 
        <a href="https://flask.palletsprojects.com/" class="link link-primary">Flask</a> 
        and 
        <a href="https://daisyui.com/" class="link link-primary">DaisyUI</a>
      </p>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Get today's date in YYYY-MM-DD format
function getTodayDate() {
  const today = new Date();
  return today.toISOString().split('T')[0];
}

// Format currency input
function formatCurrency(input) {
  let value = input.value.replace(/[^\d.]/g, '');
  
  // Handle multiple decimal points
  const parts = value.split('.');
  if (parts.length > 2) {
    value = parts[0] + '.' + parts.slice(1).join('');
  }
  
  // Limit to 2 decimal places
  if (parts[1] && parts[1].length > 2) {
    value = parts[0] + '.' + parts[1].substring(0, 2);
  }
  
  input.value = value;
}

// Open transaction modal with specified direction
function openTransactionModal(direction) {
  const modal = document.getElementById('transactionModal');
  const depositTab = document.getElementById('depositTab');
  const withdrawTab = document.getElementById('withdrawTab');
  const depositLabel = document.getElementById('depositLabel');
  const withdrawLabel = document.getElementById('withdrawLabel');
  const submitBtn = document.getElementById('submitBtn');
  const dateInput = document.getElementById('dateInput');
  const amountInput = document.getElementById('amountInput');
  const form = document.getElementById('transactionForm');
  
  // Set today's date as default
  dateInput.value = getTodayDate();
  
  // Clear form
  form.reset();
  dateInput.value = getTodayDate(); // Reset date after form reset
  
  // Set direction based on parameter
  if (direction === 'deposit') {
    depositTab.checked = true;
    depositLabel.classList.add('tab-active');
    withdrawLabel.classList.remove('tab-active');
    submitBtn.textContent = 'Add Deposit';
    submitBtn.className = 'btn btn-success';
  } else {
    withdrawTab.checked = true;
    withdrawLabel.classList.add('tab-active');
    depositLabel.classList.remove('tab-active');
    submitBtn.textContent = 'Add Withdrawal';
    submitBtn.className = 'btn btn-warning';
  }
  
  modal.showModal();
}

// Handle tab switching
function switchTab(direction) {
  const depositTab = document.getElementById('depositTab');
  const withdrawTab = document.getElementById('withdrawTab');
  const depositLabel = document.getElementById('depositLabel');
  const withdrawLabel = document.getElementById('withdrawLabel');
  const submitBtn = document.getElementById('submitBtn');
  
  if (direction === 'deposit') {
    depositTab.checked = true;
    depositLabel.classList.add('tab-active');
    withdrawLabel.classList.remove('tab-active');
    submitBtn.textContent = 'Add Deposit';
    submitBtn.className = 'btn btn-success';
  } else {
    withdrawTab.checked = true;
    withdrawLabel.classList.add('tab-active');
    depositLabel.classList.remove('tab-active');
    submitBtn.textContent = 'Add Withdrawal';
    submitBtn.className = 'btn btn-warning';
  }
}

// Handle form submission
async function handleTransactionSubmit(event) {
  event.preventDefault();
  
  const submitBtn = document.getElementById('submitBtn');
  const originalText = submitBtn.textContent;
  
  // Show loading state
  submitBtn.disabled = true;
  submitBtn.textContent = 'Processing...';
  
  const formData = new FormData(event.target);
  const data = {
    direction: formData.get('direction'),
    amount: formData.get('amount'),
    description: formData.get('description') || '',
    date: formData.get('date')
  };
  
  // Basic validation
  if (!data.amount || parseFloat(data.amount) <= 0) {
    alert('Please enter a valid amount');
    submitBtn.disabled = false;
    submitBtn.textContent = originalText;
    return;
  }
  
  try {
    const response = await fetch('/add_transaction', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(data)
    });
    
    const result = await response.json();
    
    if (result.success) {
      alert(result.message);
      document.getElementById('transactionModal').close();
      // Refresh the chart and balance with new data
      loadFinancialChart();
      updateBalance();
    } else {
      alert('Error: ' + result.message);
    }
  } catch (error) {
    console.error('Error:', error);
    alert('An error occurred while processing the transaction');
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = originalText;
  }
}

// Chart.js instance variable
let financialChart = null;

// Load and display financial chart
async function loadFinancialChart() {
  const chartCanvas = document.getElementById('financialChart');
  const loadingMsg = document.getElementById('chartLoadingMsg');
  const emptyMsg = document.getElementById('chartEmptyMsg');
  
  try {
    // Show loading state
    loadingMsg.style.display = 'flex';
    emptyMsg.style.display = 'none';
    chartCanvas.style.display = 'block';
    
    // Fetch chart data from backend
    const response = await fetch('/api/transactions/chart_data');
    if (!response.ok) {
      throw new Error('Failed to fetch chart data');
    }
    
    const chartData = await response.json();
    
    // Hide loading message
    loadingMsg.style.display = 'none';
    
    // Check if we have data
    if (!chartData.labels || chartData.labels.length === 0) {
      chartCanvas.style.display = 'none';
      emptyMsg.style.display = 'flex';
      return;
    }
    
    // Destroy existing chart if it exists
    if (financialChart) {
      financialChart.destroy();
    }
    
    // Format dates for display
    const formattedLabels = chartData.labels.map(date => {
      const d = new Date(date);
      return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    });
    
    // Create the chart
    const ctx = chartCanvas.getContext('2d');
    financialChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: formattedLabels,
        datasets: [{
          label: 'Account Balance',
          data: chartData.data,
          fill: true,
          backgroundColor: 'rgba(75, 192, 192, 0.1)',
          borderColor: 'rgb(75, 192, 192)',
          borderWidth: 3,
          tension: 0.2,
          pointBackgroundColor: 'rgb(75, 192, 192)',
          pointBorderColor: 'rgb(255, 255, 255)',
          pointBorderWidth: 2,
          pointRadius: 5,
          pointHoverRadius: 7
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          intersect: false,
          mode: 'index'
        },
        plugins: {
          legend: {
            display: true,
            position: 'top',
            labels: {
              font: {
                size: 14
              },
              padding: 20
            }
          },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            titleFont: {
              size: 14
            },
            bodyFont: {
              size: 13
            },
            callbacks: {
              label: function(context) {
                return 'Balance: $' + context.parsed.y.toFixed(2);
              }
            }
          }
        },
        scales: {
          x: {
            display: true,
            title: {
              display: true,
              text: 'Date',
              font: {
                size: 14,
                weight: 'bold'
              }
            },
            grid: {
              color: 'rgba(0, 0, 0, 0.1)'
            }
          },
          y: {
            display: true,
            title: {
              display: true,
              text: 'Total Value ($)',
              font: {
                size: 14,
                weight: 'bold'
              }
            },
            beginAtZero: true,
            grid: {
              color: 'rgba(0, 0, 0, 0.1)'
            },
            ticks: {
              callback: function(value) {
                return '$' + value.toFixed(0);
              }
            }
          }
        }
      }
    });
    
  } catch (error) {
    console.error('Error loading chart:', error);
    loadingMsg.style.display = 'none';
    chartCanvas.style.display = 'none';
    
    // Show error message
    const errorMsg = document.createElement('div');
    errorMsg.className = 'absolute inset-0 flex items-center justify-center text-base-content/60';
    errorMsg.innerHTML = `
      <div class="text-center">
        <i class="bi bi-exclamation-triangle text-4xl mb-4 text-warning"></i>
        <p class="text-lg">Failed to load chart</p>
        <p class="text-sm">Please refresh the page to try again</p>
      </div>
    `;
    document.querySelector('.bg-base-100.rounded-lg.p-6').appendChild(errorMsg);
  }
}

// Load and update current balance
async function updateBalance() {
  try {
    const response = await fetch('/api/balance');
    if (!response.ok) {
      throw new Error('Failed to fetch balance');
    }
    
    const balanceData = await response.json();
    
    // Update balance display
    const balanceElement = document.getElementById('currentBalance');
    const transactionCountElement = document.getElementById('transactionCount');
    
    if (balanceElement) {
      balanceElement.textContent = balanceData.balance.toFixed(2);
    }
    
    if (transactionCountElement) {
      const count = balanceData.transaction_count;
      transactionCountElement.textContent = `${count} transaction${count !== 1 ? 's' : ''}`;
    }
    
  } catch (error) {
    console.error('Error updating balance:', error);
  }
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
  const amountInput = document.getElementById('amountInput');
  const transactionForm = document.getElementById('transactionForm');
  const depositLabel = document.getElementById('depositLabel');
  const withdrawLabel = document.getElementById('withdrawLabel');
  
  // Load the financial chart and balance
  loadFinancialChart();
  updateBalance();
  
  // Add currency formatting to amount input
  amountInput.addEventListener('input', function() {
    formatCurrency(this);
  });
  
  // Add form submission handler
  transactionForm.addEventListener('submit', handleTransactionSubmit);
  
  // Add click handlers for tabs
  depositLabel.addEventListener('click', function() {
    switchTab('deposit');
  });
  
  withdrawLabel.addEventListener('click', function() {
    switchTab('withdraw');
  });
});
</script>
{% endblock %}
